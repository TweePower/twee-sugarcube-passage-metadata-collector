// repository: https://github.com/TweePower/twee-sugarcube-passage-metadata-collector

const passageMetadataWidgetName = 'PassageMetadata';
const mode = 'byTag';
const modeParams = { filterTag: 'passage_metadata' };

(function () {
    'use strict';

    var PassageMetadataAppExport;(()=>{"use strict";var __webpack_modules__={62:(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{A:()=>PassageMetadataCollector});var _PassageMetadata__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(265),_PassageMetadataCollection__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(629),_error_PassageMetadataError__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(688),_EventHandlerCollection__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(346);class PassageMetadataCollector{constructor(e,a="PassageMetadata",t="byTag",s={filterTag:"passage_metadata"}){if(this.sugarcubeFacade=e,this.mode=t,this.modeParams=s,this.onBeforeAddMetadata=new _EventHandlerCollection__WEBPACK_IMPORTED_MODULE_3__.A,this.onAfterAddMetadata=new _EventHandlerCollection__WEBPACK_IMPORTED_MODULE_3__.A,"string"!=typeof a)throw new TypeError(`${this.constructor.name}.constructor: Invalid type for argument 'passageMetadataWidgetName'. Expected RegExp, got ${typeof a}.`);if(!/^[a-zA-Z]+$/gs.test(a))throw new RangeError(`${this.constructor.name}.constructor: Invalid value for argument 'passageMetadataWidgetName'. Expected string [a-zA-Z]+, got ${a}.`);if(this.passageMetadataRegex=new RegExp(`<<${a}>>(.*)<</${a}>>`,"gms"),"string"!=typeof t)throw new TypeError(`${this.constructor.name}.constructor: Invalid type for argument 'mode'. Expected string, got ${typeof t}.`);if(!["byTag","all"].includes(t))throw new RangeError(`${this.constructor.name}.constructor: Invalid value for argument 'mode'. Expected 'byTag' or 'all', got ${t}.`);if("byTag"===t&&"string"!=typeof s.filterTag)throw new TypeError(`${this.constructor.name}.constructor: Invalid type for argument 'modeParams.filterTag'. Expected string, got ${typeof s.filterTag}.`)}collect(){let e=this.sugarcubeFacade.getAllPassages();"byTag"===this.mode&&(e=e.filter((e=>e.tags.includes(this.modeParams.filterTag))));const a=new _PassageMetadataCollection__WEBPACK_IMPORTED_MODULE_1__.A;return e.forEach((e=>{const t="string"==typeof e.name?e.name:e.title;this.passageMetadataRegex.lastIndex=0;const s=this.passageMetadataRegex.exec(e.element.textContent);if("byTag"===this.mode&&null===s)throw new _error_PassageMetadataError__WEBPACK_IMPORTED_MODULE_2__.A(`Passage metadata not found in ${t}`);try{let e=this.createPassageMetadataObject(s[1]);e={passageName:t,...e},this.onBeforeAddMetadata.all().forEach((a=>{a(e)}));const r=new _PassageMetadata__WEBPACK_IMPORTED_MODULE_0__.A(e);a.add(r),this.onAfterAddMetadata.all().forEach((e=>{e(r)}))}catch(e){throw _error_PassageMetadataError__WEBPACK_IMPORTED_MODULE_2__.A.fromPreviousError(e,{passageName:t})}e.element.textContent=e.element.textContent.replace(s[0],"")})),a}createPassageMetadataObject(passageMetadata){let passageMetadataEvalResult;try{if(eval("passageMetadataEvalResult = "+passageMetadata),"object"!=typeof passageMetadataEvalResult||Array.isArray(passageMetadataEvalResult)||null===passageMetadataEvalResult)throw new _error_PassageMetadataError__WEBPACK_IMPORTED_MODULE_2__.A("Passage metadata JSON should contain object")}catch(e){throw new _error_PassageMetadataError__WEBPACK_IMPORTED_MODULE_2__.A(`Invalid passage metadata JSON: ${e.message}`)}return passageMetadataEvalResult}}},265:(e,a,t)=>{t.d(a,{A:()=>r});var s=t(688);class r{constructor(e){if("object"!=typeof e||Array.isArray(e)||null===e)throw new s.A(`Invalid passage metadata (expected: object, actual: ${typeof e})`);if("string"!=typeof e.passageName)throw new s.A(`Invalid passage name (expected: string, actual: ${typeof e.passageName})`);this._data={...e},this._originData={...e},this._rewriteData=null}get passageName(){return this._data.passageName}get data(){return this._data}setValue(e,a){this._data[e]=a,null===this._rewriteData&&(this._rewriteData={}),this._rewriteData[e]=a,this._rewriteData[e]===this._originData[e]&&delete this._rewriteData[e],Object.keys(this._rewriteData).length<=0&&(this._rewriteData=null)}get originData(){return this._originData}get rewriteData(){return this._rewriteData}reset(){this._rewriteData=null,this._data={...this._originData}}}},346:(e,a,t)=>{t.d(a,{A:()=>s});class s{constructor(){this.handlers=[]}add(e){this.handlers.push(e)}clear(){this.handlers=[]}count(){return this.handlers.length}all(){return this.handlers}}},629:(e,a,t)=>{t.d(a,{A:()=>r});var s=t(688);class r{constructor(){this.items={}}add(e){if(this.has(e.passageName))throw new s.A(`Passage metadata with name '${e.passageName}' already exist`);this.items[e.passageName]=e}has(e){if("string"!=typeof e)throw new s.A("passageName should be string");return void 0!==this.items[e]}get(e){if(!this.has(e))throw new s.A(`PassageMetadata with passageName ${e} doesn't exist`);return this.items[e]}find(e){return!1===this.has(e)?null:this.items[e]}}},688:(e,a,t)=>{t.d(a,{A:()=>s});class s extends Error{constructor(e,a={}){super(e),this.scope={},this.scope=a,Object.setPrototypeOf(this,s.prototype)}static fromPreviousError(e,a={}){const t=new s(e.message);return t.stack=e.stack,t.scope={...a,...e instanceof s?e.scope:{}},t}}}},__webpack_module_cache__={};function __webpack_require__(e){var a=__webpack_module_cache__[e];if(void 0!==a)return a.exports;var t=__webpack_module_cache__[e]={exports:{}};return __webpack_modules__[e](t,t.exports,__webpack_require__),t.exports}__webpack_require__.d=(e,a)=>{for(var t in a)__webpack_require__.o(a,t)&&!__webpack_require__.o(e,t)&&Object.defineProperty(e,t,{enumerable:!0,get:a[t]})},__webpack_require__.o=(e,a)=>Object.prototype.hasOwnProperty.call(e,a),__webpack_require__.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var __webpack_exports__={};__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{default:()=>PassageMetadataApp});class SugarcubeFacade{getAllPassages(){return Story.lookup()}runTeweeScript(e){return Scripting.evalJavaScript(Scripting.parse(e))}getCurrentPassage(){return passage()}hasPassage(e){return Story.has(e)}getVariable(e){return State.variables[e]}saveVariable(e,a){State.variables[e]=a}addMacros(e,a){Macro.add(e,a)}}var PassageMetadataCollector=__webpack_require__(62),PassageMetadataError=__webpack_require__(688),EventHandlerCollection=__webpack_require__(346);class PassageMetadataStateManager{constructor(e,a="passageMetadataState"){this.sugarcubeFacade=e,this.sugarcubeHistoryVariableName=a,this.onBeforeStore=new EventHandlerCollection.A,this.onBeforeRestore=new EventHandlerCollection.A}store(e){let a={};for(const t in e.items){const s=e.items[t];null!==s.rewriteData&&(a[t]={...s.rewriteData})}this.onBeforeStore.all().forEach((e=>{e(a)})),this.sugarcubeFacade.saveVariable(this.sugarcubeHistoryVariableName,this.serialize(a))}restore(e){const a=this.sugarcubeFacade.getVariable(this.sugarcubeHistoryVariableName);if("string"!=typeof a)return;const t=this.deserialize(a);for(const a in e.items)e.items[a].reset();this.onBeforeRestore.all().forEach((e=>{e(t)}));for(const a in t){if(!e.has(a))continue;const s=t[a];for(const t in s)e.get(a).setValue(t,s[t])}}deserialize(e){return JSON.parse(e)}serialize(e){return JSON.stringify(e)}}const macros=(e,a)=>{a.addMacros("setPassageMetadataVariable",{handler:function(){if(this.args.length<2||this.args.length>3)return this.error(`Invalid number of arguments: expected 2 to 3, but received ${this.args.length}.`);let a=null,t=null,s=null;if(3===this.args.length){var r;if(r="object"==typeof this.args[0]?this.args[0].link:this.args[0],"string"!=typeof this.args[1]&&"number"!=typeof this.args[1])return this.error("Invalid type for second argument: expected string or number, but recived "+typeof this.args[1]);a=e.get(r),t=this.args[1],s=this.args[2]}else{if("string"!=typeof this.args[0]&&"number"!=typeof this.args[0])return this.error("Invalid type for second argument: expected string or number, but recived "+typeof this.args[0]);a=e.get(),t=this.args[0],s=this.args[1]}a.setValue(t,s),e.storeState()}})};class PassageMetadataApp{constructor(e="PassageMetadata",a="byTag",t={filterTag:"passage_metadata"}){this._passageMetadataWidgetName=e,this._mode=a,this._modeParams=t,this._isPassageMetadataAppInitialized=!1,this._isPassageMetadataCollected=!1,this._isPassageStateLoaded=!1,this._isPassageMetadataWidgetsInitialized=!1,this.sugarcubeFacade=new SugarcubeFacade,this.passageMetadataCollector=new PassageMetadataCollector.A(this.sugarcubeFacade,e,a,t),this.passageMetadataStateManager=new PassageMetadataStateManager(this.sugarcubeFacade),this._realCurrentPassage=this.sugarcubeFacade.getCurrentPassage(),$(document).on(":passageinit",(e=>{const a=e.passage;this._realCurrentPassage="string"==typeof a.name?a.name:a.title})),$(document).on(":passagestart",(()=>{!1===this._isPassageMetadataAppInitialized&&(this._isPassageMetadataAppInitialized=!0,this.collect(),this.initWidgets()),this.loadState()})),this.onBeforeAddMetadata=this.passageMetadataCollector.onBeforeAddMetadata,this.onAfterAddMetadata=this.passageMetadataCollector.onAfterAddMetadata,this.onBeforeStore=this.passageMetadataStateManager.onBeforeStore,this.onBeforeRestore=this.passageMetadataStateManager.onBeforeRestore}get passageMetadataWidgetName(){return this._passageMetadataWidgetName}get mode(){return this._mode}get modeParams(){return{...this._modeParams}}get isInitialized(){return this._isPassageMetadataAppInitialized}get isCollected(){return this._isPassageMetadataCollected}get isStateLoaded(){return this._isPassageStateLoaded}get isWidgetsInitialized(){return this._isPassageMetadataWidgetsInitialized}resetPassageStateLoaded(){this._isPassageStateLoaded=!1}get realCurrentPassage(){return this._realCurrentPassage}collect(e=!1){if(!0===e||!0!==this._isPassageMetadataCollected){this._isPassageMetadataCollected=!0;try{this.passageMetadataCollection=this.passageMetadataCollector.collect()}catch(e){throw e instanceof PassageMetadataError.A&&(e.message+=" ("+Object.keys(e.scope).map((a=>`${a}: ${e.scope[a]}`)).join(", ")+")"),e}}}loadState(e=!1){if(!0===e||!0!==this._isPassageStateLoaded){this._isPassageStateLoaded=!0;try{this.passageMetadataStateManager.restore(this.passageMetadataCollection)}catch(e){throw e instanceof PassageMetadataError.A&&(e.message+=" ("+Object.keys(e.scope).map((a=>`${a}: ${e.scope[a]}`)).join(", ")),e}}}initWidgets(){!0!==this._isPassageMetadataWidgetsInitialized&&(this._isPassageMetadataWidgetsInitialized=!0,this.sugarcubeFacade.addMacros(this._passageMetadataWidgetName,{handler:function(){return this.error("Passage metadata was not processed, please check passage tags")}}),macros(this,this.sugarcubeFacade))}storeState(){this.passageMetadataStateManager.store(this.passageMetadataCollection)}has(e=null){if(!1===this.isCollected)throw new Error("Passage matadata was not collected");return null===e&&(e=this._realCurrentPassage),this.passageMetadataCollection.has(e)}previousHas(){if(!1===this.isCollected)throw new Error("Passage matadata was not collected");return this.passageMetadataCollection.has(previous())}find(e=null){if(!1===this.isCollected)throw new Error("Passage matadata was not collected");return null===e&&(e=this._realCurrentPassage),this.passageMetadataCollection.find(e)}get(e=null){if(!1===this.isCollected)throw new Error("Passage matadata was not collected");return null===e&&(e=this._realCurrentPassage),this.passageMetadataCollection.get(e)}getValue(e,a=null){var t;if(!1===this.isCollected)throw new Error("Passage matadata was not collected");let s=this._realCurrentPassage,r=null;if(null===a)r=e;else{if("string"!=typeof e)throw new TypeError(`${this.constructor.name}.getValue: Invalid type for argument 'passageNameOrKey'. Expected string, got ${typeof e}.`);s=e,r=a}return null===(t=this.passageMetadataCollection.find(s))||void 0===t?void 0:t.data[r]}}PassageMetadataAppExport=__webpack_exports__})();
    const PassageMetadataApp = PassageMetadataAppExport.default;

    ////////////////////////////////////////////
    /// Sugarcube hacks
    ////////////////////////////////////////////
    Engine = new Proxy(Engine, {
        get: function(target, prop) {
            if (prop === 'backward' || prop === 'forward') {
                jQuery.event.trigger({
                    type: ':called_' + prop,
                });
            }

            return target[prop];
        }
    });

    ////////////////////////////////////////////
    /// initialize PassageMetadataApp
    ////////////////////////////////////////////
    window.passageMetadataApp = new PassageMetadataApp(
        passageMetadataWidgetName,
        mode,
        modeParams,
    );

    $(document).on(':called_backward', function() {
        window.passageMetadataApp.resetPassageStateLoaded();
    });

    $(document).on(':called_forward', function() {
        window.passageMetadataApp.resetPassageStateLoaded();
    });

    Save.onLoad.add((save) => {
        if (save.state.history.length > 0) {
            window.passageMetadataApp.resetPassageStateLoaded();
        }
    });
})();
