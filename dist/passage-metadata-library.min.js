var PassageMetadataAppExport;(()=>{var __webpack_modules__={17:e=>{"use strict";e.exports=function e(t,a){if(t===a)return!0;if(t&&a&&"object"==typeof t&&"object"==typeof a){if(t.constructor!==a.constructor)return!1;var r,s,i;if(Array.isArray(t)){if((r=t.length)!=a.length)return!1;for(s=r;0!=s--;)if(!e(t[s],a[s]))return!1;return!0}if(t.constructor===RegExp)return t.source===a.source&&t.flags===a.flags;if(t.valueOf!==Object.prototype.valueOf)return t.valueOf()===a.valueOf();if(t.toString!==Object.prototype.toString)return t.toString()===a.toString();if((r=(i=Object.keys(t)).length)!==Object.keys(a).length)return!1;for(s=r;0!=s--;)if(!Object.prototype.hasOwnProperty.call(a,i[s]))return!1;for(s=r;0!=s--;){var o=i[s];if(!e(t[o],a[o]))return!1}return!0}return t!=t&&a!=a}},62:(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.d(__webpack_exports__,{A:()=>PassageMetadataCollector});var clone__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(779),clone__WEBPACK_IMPORTED_MODULE_0___default=__webpack_require__.n(clone__WEBPACK_IMPORTED_MODULE_0__),_PassageMetadata__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(265),_PassageMetadataCollection__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(629),_error_PassageMetadataError__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(688),_EventHandlerCollection__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__(346);class PassageMetadataCollector{constructor(e,t="PassageMetadata",a="byTag",r={filterTag:"passage_metadata"}){if(this.sugarcubeFacade=e,this.mode=a,this.modeParams=r,this.onBeforeAddMetadata=new _EventHandlerCollection__WEBPACK_IMPORTED_MODULE_4__.A,this.onAfterAddMetadata=new _EventHandlerCollection__WEBPACK_IMPORTED_MODULE_4__.A,"string"!=typeof t)throw new TypeError(`${this.constructor.name}.constructor: Invalid type for argument 'passageMetadataWidgetName'. Expected RegExp, got ${typeof t}.`);if(!/^[a-zA-Z]+$/gs.test(t))throw new RangeError(`${this.constructor.name}.constructor: Invalid value for argument 'passageMetadataWidgetName'. Expected string [a-zA-Z]+, got ${t}.`);if(this.passageMetadataRegex=new RegExp(`<<${t}>>(.*)<</${t}>>`,"gms"),"string"!=typeof a)throw new TypeError(`${this.constructor.name}.constructor: Invalid type for argument 'mode'. Expected string, got ${typeof a}.`);if(!["byTag","all"].includes(a))throw new RangeError(`${this.constructor.name}.constructor: Invalid value for argument 'mode'. Expected 'byTag' or 'all', got ${a}.`);if("byTag"===a&&"string"!=typeof r.filterTag)throw new TypeError(`${this.constructor.name}.constructor: Invalid type for argument 'modeParams.filterTag'. Expected string, got ${typeof r.filterTag}.`)}collect(){let e=this.sugarcubeFacade.getAllPassages();"byTag"===this.mode&&(e=e.filter((e=>e.tags.includes(this.modeParams.filterTag))));const t=new _PassageMetadataCollection__WEBPACK_IMPORTED_MODULE_2__.A;return e.forEach((e=>{const a="string"==typeof e.name?e.name:e.title;this.passageMetadataRegex.lastIndex=0;const r=this.passageMetadataRegex.exec(e.element.textContent);if("byTag"===this.mode&&null===r)throw new _error_PassageMetadataError__WEBPACK_IMPORTED_MODULE_3__.A(`Passage metadata not found in ${a}`);try{let e=this.createPassageMetadataObject(r[1]);e={passageName:a,...clone__WEBPACK_IMPORTED_MODULE_0___default()(e)},this.onBeforeAddMetadata.all().forEach((t=>{t(e)}));const s=new _PassageMetadata__WEBPACK_IMPORTED_MODULE_1__.A(e);t.add(s),this.onAfterAddMetadata.all().forEach((e=>{e(s)}))}catch(e){throw _error_PassageMetadataError__WEBPACK_IMPORTED_MODULE_3__.A.fromPreviousError(e,{passageName:a})}e.element.textContent=e.element.textContent.replace(r[0],"")})),t}createPassageMetadataObject(passageMetadata){let passageMetadataEvalResult;try{if(eval("passageMetadataEvalResult = "+passageMetadata),"object"!=typeof passageMetadataEvalResult||Array.isArray(passageMetadataEvalResult)||null===passageMetadataEvalResult)throw new _error_PassageMetadataError__WEBPACK_IMPORTED_MODULE_3__.A("Passage metadata JSON should contain object")}catch(e){throw new _error_PassageMetadataError__WEBPACK_IMPORTED_MODULE_3__.A(`Invalid passage metadata JSON: ${e.message}`)}return passageMetadataEvalResult}}},265:(e,t,a)=>{"use strict";a.d(t,{A:()=>_});var r=a(779),s=a.n(r),i=a(17),o=a.n(i),n=a(688);class _{constructor(e){if("object"!=typeof e||Array.isArray(e)||null===e)throw new n.A(`Invalid passage metadata (expected: object, actual: ${typeof e})`);if("string"!=typeof e.passageName)throw new n.A(`Invalid passage name (expected: string, actual: ${typeof e.passageName})`);this._data=s()(e),this._originData=s()(e),this._rewriteData=null}get passageName(){return this._data.passageName}get data(){return this._data}setValue(e,t){this._data[e]=t,null===this._rewriteData&&(this._rewriteData={}),this._rewriteData[e]=t,o()(this._rewriteData[e],this._originData[e])&&delete this._rewriteData[e],Object.keys(this._rewriteData).length<=0&&(this._rewriteData=null)}get originData(){return this._originData}get rewriteData(){return this._rewriteData}reset(){this._rewriteData=null,this._data=s()(this._originData)}}},346:(e,t,a)=>{"use strict";a.d(t,{A:()=>r});class r{constructor(){this.handlers=[]}add(e){this.handlers.push(e)}clear(){this.handlers=[]}count(){return this.handlers.length}all(){return this.handlers}}},629:(e,t,a)=>{"use strict";a.d(t,{A:()=>s});var r=a(688);class s{constructor(){this.items={}}add(e){if(this.has(e.passageName))throw new r.A(`Passage metadata with name '${e.passageName}' already exist`);this.items[e.passageName]=e}has(e){if("string"!=typeof e)throw new r.A("passageName should be string");return void 0!==this.items[e]}get(e){if(!this.has(e))throw new r.A(`PassageMetadata with passageName ${e} doesn't exist`);return this.items[e]}find(e){return!1===this.has(e)?null:this.items[e]}}},688:(e,t,a)=>{"use strict";a.d(t,{A:()=>r});class r extends Error{constructor(e,t={}){super(e),this.scope={},this.scope=t,Object.setPrototypeOf(this,r.prototype)}static fromPreviousError(e,t={}){const a=new r(e.message);return a.stack=e.stack,a.scope={...t,...e instanceof r?e.scope:{}},a}}},779:e=>{var t=function(){"use strict";function e(e,t){return null!=t&&e instanceof t}var t,a,r;try{t=Map}catch(e){t=function(){}}try{a=Set}catch(e){a=function(){}}try{r=Promise}catch(e){r=function(){}}function s(i,n,_,c,l){"object"==typeof n&&(_=n.depth,c=n.prototype,l=n.includeNonEnumerable,n=n.circular);var d=[],g=[],u="undefined"!=typeof Buffer;return void 0===n&&(n=!0),void 0===_&&(_=1/0),function i(_,p){if(null===_)return null;if(0===p)return _;var h,f;if("object"!=typeof _)return _;if(e(_,t))h=new t;else if(e(_,a))h=new a;else if(e(_,r))h=new r((function(e,t){_.then((function(t){e(i(t,p-1))}),(function(e){t(i(e,p-1))}))}));else if(s.__isArray(_))h=[];else if(s.__isRegExp(_))h=new RegExp(_.source,o(_)),_.lastIndex&&(h.lastIndex=_.lastIndex);else if(s.__isDate(_))h=new Date(_.getTime());else{if(u&&Buffer.isBuffer(_))return h=Buffer.allocUnsafe?Buffer.allocUnsafe(_.length):new Buffer(_.length),_.copy(h),h;e(_,Error)?h=Object.create(_):void 0===c?(f=Object.getPrototypeOf(_),h=Object.create(f)):(h=Object.create(c),f=c)}if(n){var b=d.indexOf(_);if(-1!=b)return g[b];d.push(_),g.push(h)}for(var m in e(_,t)&&_.forEach((function(e,t){var a=i(t,p-1),r=i(e,p-1);h.set(a,r)})),e(_,a)&&_.forEach((function(e){var t=i(e,p-1);h.add(t)})),_){var w;f&&(w=Object.getOwnPropertyDescriptor(f,m)),w&&null==w.set||(h[m]=i(_[m],p-1))}if(Object.getOwnPropertySymbols){var M=Object.getOwnPropertySymbols(_);for(m=0;m<M.length;m++){var P=M[m];(!(E=Object.getOwnPropertyDescriptor(_,P))||E.enumerable||l)&&(h[P]=i(_[P],p-1),E.enumerable||Object.defineProperty(h,P,{enumerable:!1}))}}if(l){var y=Object.getOwnPropertyNames(_);for(m=0;m<y.length;m++){var E,v=y[m];(E=Object.getOwnPropertyDescriptor(_,v))&&E.enumerable||(h[v]=i(_[v],p-1),Object.defineProperty(h,v,{enumerable:!1}))}}return h}(i,_)}function i(e){return Object.prototype.toString.call(e)}function o(e){var t="";return e.global&&(t+="g"),e.ignoreCase&&(t+="i"),e.multiline&&(t+="m"),t}return s.clonePrototype=function(e){if(null===e)return null;var t=function(){};return t.prototype=e,new t},s.__objToStr=i,s.__isDate=function(e){return"object"==typeof e&&"[object Date]"===i(e)},s.__isArray=function(e){return"object"==typeof e&&"[object Array]"===i(e)},s.__isRegExp=function(e){return"object"==typeof e&&"[object RegExp]"===i(e)},s.__getRegExpFlags=o,s}();e.exports&&(e.exports=t)}},__webpack_module_cache__={};function __webpack_require__(e){var t=__webpack_module_cache__[e];if(void 0!==t)return t.exports;var a=__webpack_module_cache__[e]={exports:{}};return __webpack_modules__[e](a,a.exports,__webpack_require__),a.exports}__webpack_require__.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return __webpack_require__.d(t,{a:t}),t},__webpack_require__.d=(e,t)=>{for(var a in t)__webpack_require__.o(t,a)&&!__webpack_require__.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:t[a]})},__webpack_require__.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),__webpack_require__.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var __webpack_exports__={};(()=>{"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{default:()=>_});class e{getAllPassages(){return Story.lookup()}runTeweeScript(e){return Scripting.evalJavaScript(Scripting.parse(e))}getCurrentPassage(){return passage()}hasPassage(e){return Story.has(e)}getVariable(e){return State.variables[e]}saveVariable(e,t){State.variables[e]=t}addMacros(e,t){Macro.add(e,t)}}var t=__webpack_require__(62),a=__webpack_require__(688),r=__webpack_require__(779),s=__webpack_require__.n(r),i=__webpack_require__(346);class o{constructor(e,t="passageMetadataState"){this.sugarcubeFacade=e,this.sugarcubeHistoryVariableName=t,this.onBeforeStore=new i.A,this.onBeforeRestore=new i.A}store(e){let t={};for(const a in e.items){const r=e.items[a];null!==r.rewriteData&&(t[a]=s()(r.rewriteData))}this.onBeforeStore.all().forEach((e=>{e(t)})),this.sugarcubeFacade.saveVariable(this.sugarcubeHistoryVariableName,this.serialize(t))}restore(e){const t=this.sugarcubeFacade.getVariable(this.sugarcubeHistoryVariableName);if("string"!=typeof t)return;const a=this.deserialize(t);for(const t in e.items)e.items[t].reset();this.onBeforeRestore.all().forEach((e=>{e(a)}));for(const t in a){if(!e.has(t))continue;const r=a[t];for(const a in r)e.get(t).setValue(a,r[a])}}deserialize(e){return JSON.parse(e)}serialize(e){return JSON.stringify(e)}}const n=(e,t)=>{t.addMacros("setPassageMetadataVariable",{handler:function(){if(this.args.length<2||this.args.length>3)return this.error(`Invalid number of arguments: expected 2 to 3, but received ${this.args.length}.`);let t=null,a=null,r=null;if(3===this.args.length){var s;if(s="object"==typeof this.args[0]?this.args[0].link:this.args[0],"string"!=typeof this.args[1]&&"number"!=typeof this.args[1])return this.error("Invalid type for second argument: expected string or number, but recived "+typeof this.args[1]);t=e.get(s),a=this.args[1],r=this.args[2]}else{if("string"!=typeof this.args[0]&&"number"!=typeof this.args[0])return this.error("Invalid type for second argument: expected string or number, but recived "+typeof this.args[0]);t=e.get(),a=this.args[0],r=this.args[1]}t.setValue(a,r),e.storeState()}})};class _{constructor(a="PassageMetadata",r="byTag",s={filterTag:"passage_metadata"}){this._passageMetadataWidgetName=a,this._mode=r,this._modeParams=s,this._isPassageMetadataAppInitialized=!1,this._isPassageMetadataCollected=!1,this._isPassageStateLoaded=!1,this._isPassageMetadataWidgetsInitialized=!1,this.sugarcubeFacade=new e,this.passageMetadataCollector=new t.A(this.sugarcubeFacade,a,r,s),this.passageMetadataStateManager=new o(this.sugarcubeFacade),this._realCurrentPassage=this.sugarcubeFacade.getCurrentPassage(),$(document).on(":passageinit",(e=>{const t=e.passage;this._realCurrentPassage="string"==typeof t.name?t.name:t.title})),$(document).on(":passagestart",(()=>{!1===this._isPassageMetadataAppInitialized&&(this._isPassageMetadataAppInitialized=!0,this.collect(),this.initWidgets()),this.loadState()})),this.onBeforeAddMetadata=this.passageMetadataCollector.onBeforeAddMetadata,this.onAfterAddMetadata=this.passageMetadataCollector.onAfterAddMetadata,this.onBeforeStore=this.passageMetadataStateManager.onBeforeStore,this.onBeforeRestore=this.passageMetadataStateManager.onBeforeRestore}get passageMetadataWidgetName(){return this._passageMetadataWidgetName}get mode(){return this._mode}get modeParams(){return clone(this._modeParams)}get isInitialized(){return this._isPassageMetadataAppInitialized}get isCollected(){return this._isPassageMetadataCollected}get isStateLoaded(){return this._isPassageStateLoaded}get isWidgetsInitialized(){return this._isPassageMetadataWidgetsInitialized}resetPassageStateLoaded(){this._isPassageStateLoaded=!1}get realCurrentPassage(){return this._realCurrentPassage}collect(e=!1){if(!0===e||!0!==this._isPassageMetadataCollected){this._isPassageMetadataCollected=!0;try{this.passageMetadataCollection=this.passageMetadataCollector.collect()}catch(e){throw e instanceof a.A&&(e.message+=" ("+Object.keys(e.scope).map((t=>`${t}: ${e.scope[t]}`)).join(", ")+")"),e}}}loadState(e=!1){if(!0===e||!0!==this._isPassageStateLoaded){this._isPassageStateLoaded=!0;try{this.passageMetadataStateManager.restore(this.passageMetadataCollection)}catch(e){throw e instanceof a.A&&(e.message+=" ("+Object.keys(e.scope).map((t=>`${t}: ${e.scope[t]}`)).join(", ")),e}}}initWidgets(){!0!==this._isPassageMetadataWidgetsInitialized&&(this._isPassageMetadataWidgetsInitialized=!0,this.sugarcubeFacade.addMacros(this._passageMetadataWidgetName,{handler:function(){return this.error("Passage metadata was not processed, please check passage tags")}}),n(this,this.sugarcubeFacade))}storeState(){this.passageMetadataStateManager.store(this.passageMetadataCollection)}has(e=null){if(!1===this.isCollected)throw new Error("Passage matadata was not collected");return null===e&&(e=this._realCurrentPassage),this.passageMetadataCollection.has(e)}previousHas(){if(!1===this.isCollected)throw new Error("Passage matadata was not collected");return this.passageMetadataCollection.has(previous())}find(e=null){if(!1===this.isCollected)throw new Error("Passage matadata was not collected");return null===e&&(e=this._realCurrentPassage),this.passageMetadataCollection.find(e)}get(e=null){if(!1===this.isCollected)throw new Error("Passage matadata was not collected");return null===e&&(e=this._realCurrentPassage),this.passageMetadataCollection.get(e)}getValue(e,t=null){var a;if(!1===this.isCollected)throw new Error("Passage matadata was not collected");let r=this._realCurrentPassage,s=null;if(null===t)s=e;else{if("string"!=typeof e)throw new TypeError(`${this.constructor.name}.getValue: Invalid type for argument 'passageNameOrKey'. Expected string, got ${typeof e}.`);r=e,s=t}return null===(a=this.passageMetadataCollection.find(r))||void 0===a?void 0:a.data[s]}}})(),PassageMetadataAppExport=__webpack_exports__})();