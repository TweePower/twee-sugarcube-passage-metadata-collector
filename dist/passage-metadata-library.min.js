var PassageMetadataAppExport;(()=>{var __webpack_modules__={62:(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.d(__webpack_exports__,{A:()=>PassageMetadataCollector});var _PassageMetadata__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(265),_PassageMetadataCollection__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(629),_error_PassageMetadataError__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(688),_EventHandlerCollection__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(346);class PassageMetadataCollector{constructor(e,t="PassageMetadata",a="byTag",s={filterTag:"passage_metadata"}){if(this.sugarcubeFacade=e,this.mode=a,this.modeParams=s,this.onBeforeAddMetadata=new _EventHandlerCollection__WEBPACK_IMPORTED_MODULE_3__.A,this.onAfterAddMetadata=new _EventHandlerCollection__WEBPACK_IMPORTED_MODULE_3__.A,"string"!=typeof t)throw new TypeError(`${this.constructor.name}.constructor: Invalid type for argument 'passageMetadataWidgetName'. Expected RegExp, got ${typeof t}.`);if(!/^[a-zA-Z]+$/gs.test(t))throw new RangeError(`${this.constructor.name}.constructor: Invalid value for argument 'passageMetadataWidgetName'. Expected string [a-zA-Z]+, got ${t}.`);if(this.passageMetadataRegex=new RegExp(`<<${t}>>(.*)<</${t}>>`,"gms"),"string"!=typeof a)throw new TypeError(`${this.constructor.name}.constructor: Invalid type for argument 'mode'. Expected string, got ${typeof a}.`);if(!["byTag","all"].includes(a))throw new RangeError(`${this.constructor.name}.constructor: Invalid value for argument 'mode'. Expected 'byTag' or 'all', got ${a}.`);if("byTag"===a&&"string"!=typeof s.filterTag)throw new TypeError(`${this.constructor.name}.constructor: Invalid type for argument 'modeParams.filterTag'. Expected string, got ${typeof s.filterTag}.`)}collect(){let e=this.sugarcubeFacade.getAllPassages();"byTag"===this.mode&&(e=e.filter((e=>e.tags.includes(this.modeParams.filterTag))));const t=new _PassageMetadataCollection__WEBPACK_IMPORTED_MODULE_1__.A;return e.forEach((e=>{const a="string"==typeof e.name?e.name:e.title;this.passageMetadataRegex.lastIndex=0;const s=this.passageMetadataRegex.exec(e.element.textContent);if("byTag"===this.mode&&null===s)throw new _error_PassageMetadataError__WEBPACK_IMPORTED_MODULE_2__.A(`Passage metadata not found in ${a}`);try{let e=this.createPassageMetadataObject(s[1]);e={passageName:a,...clone(e)},this.onBeforeAddMetadata.all().forEach((t=>{t(e)}));const r=new _PassageMetadata__WEBPACK_IMPORTED_MODULE_0__.A(e);t.add(r),this.onAfterAddMetadata.all().forEach((e=>{e(r)}))}catch(e){throw _error_PassageMetadataError__WEBPACK_IMPORTED_MODULE_2__.A.fromPreviousError(e,{passageName:a})}e.element.textContent=e.element.textContent.replace(s[0],"")})),t}createPassageMetadataObject(passageMetadata){let passageMetadataEvalResult;try{if(eval("passageMetadataEvalResult = "+passageMetadata),"object"!=typeof passageMetadataEvalResult||Array.isArray(passageMetadataEvalResult)||null===passageMetadataEvalResult)throw new _error_PassageMetadataError__WEBPACK_IMPORTED_MODULE_2__.A("Passage metadata JSON should contain object")}catch(e){throw new _error_PassageMetadataError__WEBPACK_IMPORTED_MODULE_2__.A(`Invalid passage metadata JSON: ${e.message}`)}return passageMetadataEvalResult}}},265:(e,t,a)=>{"use strict";a.d(t,{A:()=>o});var s=a(779),r=a.n(s),i=a(688);class o{constructor(e){if("object"!=typeof e||Array.isArray(e)||null===e)throw new i.A(`Invalid passage metadata (expected: object, actual: ${typeof e})`);if("string"!=typeof e.passageName)throw new i.A(`Invalid passage name (expected: string, actual: ${typeof e.passageName})`);this._data=r()(e),this._originData=r()(e),this._rewriteData=null}get passageName(){return this._data.passageName}get data(){return this._data}setValue(e,t){this._data[e]=t,null===this._rewriteData&&(this._rewriteData={}),this._rewriteData[e]=t,this._rewriteData[e]===this._originData[e]&&delete this._rewriteData[e],Object.keys(this._rewriteData).length<=0&&(this._rewriteData=null)}get originData(){return this._originData}get rewriteData(){return this._rewriteData}reset(){this._rewriteData=null,this._data=r()(this._originData)}}},346:(e,t,a)=>{"use strict";a.d(t,{A:()=>s});class s{constructor(){this.handlers=[]}add(e){this.handlers.push(e)}clear(){this.handlers=[]}count(){return this.handlers.length}all(){return this.handlers}}},629:(e,t,a)=>{"use strict";a.d(t,{A:()=>r});var s=a(688);class r{constructor(){this.items={}}add(e){if(this.has(e.passageName))throw new s.A(`Passage metadata with name '${e.passageName}' already exist`);this.items[e.passageName]=e}has(e){if("string"!=typeof e)throw new s.A("passageName should be string");return void 0!==this.items[e]}get(e){if(!this.has(e))throw new s.A(`PassageMetadata with passageName ${e} doesn't exist`);return this.items[e]}find(e){return!1===this.has(e)?null:this.items[e]}}},688:(e,t,a)=>{"use strict";a.d(t,{A:()=>s});class s extends Error{constructor(e,t={}){super(e),this.scope={},this.scope=t,Object.setPrototypeOf(this,s.prototype)}static fromPreviousError(e,t={}){const a=new s(e.message);return a.stack=e.stack,a.scope={...t,...e instanceof s?e.scope:{}},a}}},779:e=>{var t=function(){"use strict";function e(e,t){return null!=t&&e instanceof t}var t,a,s;try{t=Map}catch(e){t=function(){}}try{a=Set}catch(e){a=function(){}}try{s=Promise}catch(e){s=function(){}}function r(i,n,_,l,c){"object"==typeof n&&(_=n.depth,l=n.prototype,c=n.includeNonEnumerable,n=n.circular);var d=[],g=[],u="undefined"!=typeof Buffer;return void 0===n&&(n=!0),void 0===_&&(_=1/0),function i(_,h){if(null===_)return null;if(0===h)return _;var p,f;if("object"!=typeof _)return _;if(e(_,t))p=new t;else if(e(_,a))p=new a;else if(e(_,s))p=new s((function(e,t){_.then((function(t){e(i(t,h-1))}),(function(e){t(i(e,h-1))}))}));else if(r.__isArray(_))p=[];else if(r.__isRegExp(_))p=new RegExp(_.source,o(_)),_.lastIndex&&(p.lastIndex=_.lastIndex);else if(r.__isDate(_))p=new Date(_.getTime());else{if(u&&Buffer.isBuffer(_))return p=Buffer.allocUnsafe?Buffer.allocUnsafe(_.length):new Buffer(_.length),_.copy(p),p;e(_,Error)?p=Object.create(_):void 0===l?(f=Object.getPrototypeOf(_),p=Object.create(f)):(p=Object.create(l),f=l)}if(n){var m=d.indexOf(_);if(-1!=m)return g[m];d.push(_),g.push(p)}for(var b in e(_,t)&&_.forEach((function(e,t){var a=i(t,h-1),s=i(e,h-1);p.set(a,s)})),e(_,a)&&_.forEach((function(e){var t=i(e,h-1);p.add(t)})),_){var w;f&&(w=Object.getOwnPropertyDescriptor(f,b)),w&&null==w.set||(p[b]=i(_[b],h-1))}if(Object.getOwnPropertySymbols){var M=Object.getOwnPropertySymbols(_);for(b=0;b<M.length;b++){var P=M[b];(!(E=Object.getOwnPropertyDescriptor(_,P))||E.enumerable||c)&&(p[P]=i(_[P],h-1),E.enumerable||Object.defineProperty(p,P,{enumerable:!1}))}}if(c){var y=Object.getOwnPropertyNames(_);for(b=0;b<y.length;b++){var E,v=y[b];(E=Object.getOwnPropertyDescriptor(_,v))&&E.enumerable||(p[v]=i(_[v],h-1),Object.defineProperty(p,v,{enumerable:!1}))}}return p}(i,_)}function i(e){return Object.prototype.toString.call(e)}function o(e){var t="";return e.global&&(t+="g"),e.ignoreCase&&(t+="i"),e.multiline&&(t+="m"),t}return r.clonePrototype=function(e){if(null===e)return null;var t=function(){};return t.prototype=e,new t},r.__objToStr=i,r.__isDate=function(e){return"object"==typeof e&&"[object Date]"===i(e)},r.__isArray=function(e){return"object"==typeof e&&"[object Array]"===i(e)},r.__isRegExp=function(e){return"object"==typeof e&&"[object RegExp]"===i(e)},r.__getRegExpFlags=o,r}();e.exports&&(e.exports=t)}},__webpack_module_cache__={};function __webpack_require__(e){var t=__webpack_module_cache__[e];if(void 0!==t)return t.exports;var a=__webpack_module_cache__[e]={exports:{}};return __webpack_modules__[e](a,a.exports,__webpack_require__),a.exports}__webpack_require__.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return __webpack_require__.d(t,{a:t}),t},__webpack_require__.d=(e,t)=>{for(var a in t)__webpack_require__.o(t,a)&&!__webpack_require__.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:t[a]})},__webpack_require__.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),__webpack_require__.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var __webpack_exports__={};(()=>{"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{default:()=>o});class e{getAllPassages(){return Story.lookup()}runTeweeScript(e){return Scripting.evalJavaScript(Scripting.parse(e))}getCurrentPassage(){return passage()}hasPassage(e){return Story.has(e)}getVariable(e){return State.variables[e]}saveVariable(e,t){State.variables[e]=t}addMacros(e,t){Macro.add(e,t)}}var t=__webpack_require__(62),a=__webpack_require__(688),s=__webpack_require__(346);class r{constructor(e,t="passageMetadataState"){this.sugarcubeFacade=e,this.sugarcubeHistoryVariableName=t,this.onBeforeStore=new s.A,this.onBeforeRestore=new s.A}store(e){let t={};for(const a in e.items){const s=e.items[a];null!==s.rewriteData&&(t[a]=clone(s.rewriteData))}this.onBeforeStore.all().forEach((e=>{e(t)})),this.sugarcubeFacade.saveVariable(this.sugarcubeHistoryVariableName,this.serialize(t))}restore(e){const t=this.sugarcubeFacade.getVariable(this.sugarcubeHistoryVariableName);if("string"!=typeof t)return;const a=this.deserialize(t);for(const t in e.items)e.items[t].reset();this.onBeforeRestore.all().forEach((e=>{e(a)}));for(const t in a){if(!e.has(t))continue;const s=a[t];for(const a in s)e.get(t).setValue(a,s[a])}}deserialize(e){return JSON.parse(e)}serialize(e){return JSON.stringify(e)}}const i=(e,t)=>{t.addMacros("setPassageMetadataVariable",{handler:function(){if(this.args.length<2||this.args.length>3)return this.error(`Invalid number of arguments: expected 2 to 3, but received ${this.args.length}.`);let t=null,a=null,s=null;if(3===this.args.length){var r;if(r="object"==typeof this.args[0]?this.args[0].link:this.args[0],"string"!=typeof this.args[1]&&"number"!=typeof this.args[1])return this.error("Invalid type for second argument: expected string or number, but recived "+typeof this.args[1]);t=e.get(r),a=this.args[1],s=this.args[2]}else{if("string"!=typeof this.args[0]&&"number"!=typeof this.args[0])return this.error("Invalid type for second argument: expected string or number, but recived "+typeof this.args[0]);t=e.get(),a=this.args[0],s=this.args[1]}t.setValue(a,s),e.storeState()}})};class o{constructor(a="PassageMetadata",s="byTag",i={filterTag:"passage_metadata"}){this._passageMetadataWidgetName=a,this._mode=s,this._modeParams=i,this._isPassageMetadataAppInitialized=!1,this._isPassageMetadataCollected=!1,this._isPassageStateLoaded=!1,this._isPassageMetadataWidgetsInitialized=!1,this.sugarcubeFacade=new e,this.passageMetadataCollector=new t.A(this.sugarcubeFacade,a,s,i),this.passageMetadataStateManager=new r(this.sugarcubeFacade),this._realCurrentPassage=this.sugarcubeFacade.getCurrentPassage(),$(document).on(":passageinit",(e=>{const t=e.passage;this._realCurrentPassage="string"==typeof t.name?t.name:t.title})),$(document).on(":passagestart",(()=>{!1===this._isPassageMetadataAppInitialized&&(this._isPassageMetadataAppInitialized=!0,this.collect(),this.initWidgets()),this.loadState()})),this.onBeforeAddMetadata=this.passageMetadataCollector.onBeforeAddMetadata,this.onAfterAddMetadata=this.passageMetadataCollector.onAfterAddMetadata,this.onBeforeStore=this.passageMetadataStateManager.onBeforeStore,this.onBeforeRestore=this.passageMetadataStateManager.onBeforeRestore}get passageMetadataWidgetName(){return this._passageMetadataWidgetName}get mode(){return this._mode}get modeParams(){return clone(this._modeParams)}get isInitialized(){return this._isPassageMetadataAppInitialized}get isCollected(){return this._isPassageMetadataCollected}get isStateLoaded(){return this._isPassageStateLoaded}get isWidgetsInitialized(){return this._isPassageMetadataWidgetsInitialized}resetPassageStateLoaded(){this._isPassageStateLoaded=!1}get realCurrentPassage(){return this._realCurrentPassage}collect(e=!1){if(!0===e||!0!==this._isPassageMetadataCollected){this._isPassageMetadataCollected=!0;try{this.passageMetadataCollection=this.passageMetadataCollector.collect()}catch(e){throw e instanceof a.A&&(e.message+=" ("+Object.keys(e.scope).map((t=>`${t}: ${e.scope[t]}`)).join(", ")+")"),e}}}loadState(e=!1){if(!0===e||!0!==this._isPassageStateLoaded){this._isPassageStateLoaded=!0;try{this.passageMetadataStateManager.restore(this.passageMetadataCollection)}catch(e){throw e instanceof a.A&&(e.message+=" ("+Object.keys(e.scope).map((t=>`${t}: ${e.scope[t]}`)).join(", ")),e}}}initWidgets(){!0!==this._isPassageMetadataWidgetsInitialized&&(this._isPassageMetadataWidgetsInitialized=!0,this.sugarcubeFacade.addMacros(this._passageMetadataWidgetName,{handler:function(){return this.error("Passage metadata was not processed, please check passage tags")}}),i(this,this.sugarcubeFacade))}storeState(){this.passageMetadataStateManager.store(this.passageMetadataCollection)}has(e=null){if(!1===this.isCollected)throw new Error("Passage matadata was not collected");return null===e&&(e=this._realCurrentPassage),this.passageMetadataCollection.has(e)}previousHas(){if(!1===this.isCollected)throw new Error("Passage matadata was not collected");return this.passageMetadataCollection.has(previous())}find(e=null){if(!1===this.isCollected)throw new Error("Passage matadata was not collected");return null===e&&(e=this._realCurrentPassage),this.passageMetadataCollection.find(e)}get(e=null){if(!1===this.isCollected)throw new Error("Passage matadata was not collected");return null===e&&(e=this._realCurrentPassage),this.passageMetadataCollection.get(e)}getValue(e,t=null){var a;if(!1===this.isCollected)throw new Error("Passage matadata was not collected");let s=this._realCurrentPassage,r=null;if(null===t)r=e;else{if("string"!=typeof e)throw new TypeError(`${this.constructor.name}.getValue: Invalid type for argument 'passageNameOrKey'. Expected string, got ${typeof e}.`);s=e,r=t}return null===(a=this.passageMetadataCollection.find(s))||void 0===a?void 0:a.data[r]}}})(),PassageMetadataAppExport=__webpack_exports__})();