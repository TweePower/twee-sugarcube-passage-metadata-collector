var PassageMetadataAppExport;(()=>{"use strict";var __webpack_modules__={62:(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{A:()=>PassageMetadataCollector});var _PassageMetadata__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(265),_PassageMetadataCollection__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(629),_error_PassageMetadataError__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(688),_EventHandlerCollection__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(346);class PassageMetadataCollector{constructor(a,e="PassageMetadata",t="byTag",s={filterTag:"passage_metadata"}){if(this.sugarcubeFacade=a,this.mode=t,this.modeParams=s,this.onBeforeAddMetadata=new _EventHandlerCollection__WEBPACK_IMPORTED_MODULE_3__.A,this.onAfterAddMetadata=new _EventHandlerCollection__WEBPACK_IMPORTED_MODULE_3__.A,"string"!=typeof e)throw new TypeError(`${this.constructor.name}.constructor: Invalid type for argument 'passageMetadataWidgetName'. Expected RegExp, got ${typeof e}.`);if(!/^[a-zA-Z]+$/gs.test(e))throw new RangeError(`${this.constructor.name}.constructor: Invalid value for argument 'passageMetadataWidgetName'. Expected string [a-zA-Z]+, got ${e}.`);if(this.passageMetadataRegex=new RegExp(`<<${e}>>(.*)<</${e}>>`,"gms"),"string"!=typeof t)throw new TypeError(`${this.constructor.name}.constructor: Invalid type for argument 'mode'. Expected string, got ${typeof t}.`);if(!["byTag","all"].includes(t))throw new RangeError(`${this.constructor.name}.constructor: Invalid value for argument 'mode'. Expected 'byTag' or 'all', got ${t}.`);if("byTag"===t&&"string"!=typeof s.filterTag)throw new TypeError(`${this.constructor.name}.constructor: Invalid type for argument 'modeParams.filterTag'. Expected string, got ${typeof s.filterTag}.`)}collect(){let a=this.sugarcubeFacade.getAllPassages();"byTag"===this.mode&&(a=a.filter((a=>a.tags.includes(this.modeParams.filterTag))));const e=new _PassageMetadataCollection__WEBPACK_IMPORTED_MODULE_1__.A;return a.forEach((a=>{this.passageMetadataRegex.lastIndex=0;const t=this.passageMetadataRegex.exec(a.element.textContent);if("byTag"===this.mode&&null===t)throw new _error_PassageMetadataError__WEBPACK_IMPORTED_MODULE_2__.A(`Passage metadata not found in ${a.title}`);try{const s=this.createPassageMetadataObject(t[1]);this.onBeforeAddMetadata.all().forEach((a=>{a(s)}));const r=new _PassageMetadata__WEBPACK_IMPORTED_MODULE_0__.A(a.title,s);e.add(r),this.onAfterAddMetadata.all().forEach((a=>{a(r)}))}catch(e){throw _error_PassageMetadataError__WEBPACK_IMPORTED_MODULE_2__.A.fromPreviousError(e,{passage:a.title})}a.element.textContent=a.element.textContent.replace(t[0],"")})),e}createPassageMetadataObject(passageMetadata){let passageMetadataEvalResult;try{if(eval("passageMetadataEvalResult = "+passageMetadata),"object"!=typeof passageMetadataEvalResult||Array.isArray(passageMetadataEvalResult)||null===passageMetadataEvalResult)throw new _error_PassageMetadataError__WEBPACK_IMPORTED_MODULE_2__.A("Passage metadata JSON should contain object")}catch(a){throw new _error_PassageMetadataError__WEBPACK_IMPORTED_MODULE_2__.A(`Invalid passage metadata JSON: ${a.message}`)}return passageMetadataEvalResult}}},265:(a,e,t)=>{t.d(e,{A:()=>r});var s=t(688);class r{constructor(a,e){if(this._passageName=a,"string"!=typeof a)throw new s.A(`Invalid passage name (expected: string, actual: ${typeof a})`);if("object"!=typeof e||Array.isArray(e)||null===e)throw new s.A(`Invalid passage metadata (expected: object, actual: ${typeof e})`);this._data={...e},this._originData={...e},this._rewriteData=null}get passageName(){return this._passageName}get data(){return this._data}setValue(a,e){this._data[a]=e,null===this._rewriteData&&(this._rewriteData={}),this._rewriteData[a]=e,this._rewriteData[a]===this._originData[a]&&delete this._rewriteData[a],Object.keys(this._rewriteData).length<=0&&(this._rewriteData=null)}get originData(){return this._originData}get rewriteData(){return this._rewriteData}reset(){this._rewriteData=null,this._data={...this._originData}}}},346:(a,e,t)=>{t.d(e,{A:()=>s});class s{constructor(){this.handlers=[]}add(a){this.handlers.push(a)}clear(){this.handlers=[]}count(){return this.handlers.length}all(){return this.handlers}}},629:(a,e,t)=>{t.d(e,{A:()=>r});var s=t(688);class r{constructor(){this.items={}}add(a){if(this.has(a.passageName))throw new s.A(`Passage metadata with name '${a.passageName}' already exist`);this.items[a.passageName]=a}has(a){if("string"!=typeof a)throw new s.A("passageName should be string");return void 0!==this.items[a]}get(a){if(!this.has(a))throw new s.A(`PassageMetadata with passageName ${a} doesn't exist`);return this.items[a]}find(a){return!1===this.has(a)?null:this.items[a]}}},688:(a,e,t)=>{t.d(e,{A:()=>s});class s extends Error{constructor(a,e={}){super(a),this.scope={},this.scope=e,Object.setPrototypeOf(this,s.prototype)}static fromPreviousError(a,e={}){const t=new s(a.message);return t.stack=a.stack,t.scope={...e,...a instanceof s?a.scope:{}},t}}}},__webpack_module_cache__={};function __webpack_require__(a){var e=__webpack_module_cache__[a];if(void 0!==e)return e.exports;var t=__webpack_module_cache__[a]={exports:{}};return __webpack_modules__[a](t,t.exports,__webpack_require__),t.exports}__webpack_require__.d=(a,e)=>{for(var t in e)__webpack_require__.o(e,t)&&!__webpack_require__.o(a,t)&&Object.defineProperty(a,t,{enumerable:!0,get:e[t]})},__webpack_require__.o=(a,e)=>Object.prototype.hasOwnProperty.call(a,e),__webpack_require__.r=a=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(a,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(a,"__esModule",{value:!0})};var __webpack_exports__={};__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{default:()=>PassageMetadataApp});class SugarcubeFacade{getAllPassages(){return Story.lookup()}runTeweeScript(a){return Scripting.evalJavaScript(Scripting.parse(a))}getCurrentPassage(){return passage()}hasPassage(a){return Story.has(a)}getVariable(a){return State.variables[a]}saveVariable(a,e){State.variables[a]=e}addMacros(a,e){Macro.add(a,e)}}var PassageMetadataCollector=__webpack_require__(62),PassageMetadataError=__webpack_require__(688),EventHandlerCollection=__webpack_require__(346);class PassageMetadataStateManager{constructor(a,e="passageMetadataState"){this.sugarcubeFacade=a,this.sugarcubeHistoryVariableName=e,this.onBeforeStore=new EventHandlerCollection.A,this.onBeforeRestore=new EventHandlerCollection.A}store(a){let e={};for(const t in a.items){const s=a.items[t];e[t]=s.rewriteData}this.onBeforeStore.all().forEach((a=>{a(e)})),this.sugarcubeFacade.saveVariable(this.sugarcubeHistoryVariableName,this.serialize(e))}restore(a){const e=this.sugarcubeFacade.getVariable(this.sugarcubeHistoryVariableName);if("string"!=typeof e)return;const t=this.deserialize(e);for(const e in a.items)a.items[e].reset();this.onBeforeRestore.all().forEach((a=>{a(t)}));for(const e in t){if(!a.has(e))continue;const s=t[e];for(const t in s)a.get(e).setValue(t,s[t])}}deserialize(a){return JSON.parse(a)}serialize(a){return JSON.stringify(a)}}const macros=(a,e)=>{e.addMacros("setPassageMetadataVariable",{handler:function(){if(this.args.length<2||this.args.length>3)return this.error(`Invalid number of arguments: expected 2 to 3, but received ${this.args.length}.`);let e=null,t=null,s=null;if(3===this.args.length){var r;if(r="object"==typeof this.args[0]?this.args[0].link:this.args[0],"string"!=typeof this.args[1]&&"number"!=typeof this.args[1])return this.error("Invalid type for second argument: expected string or number, but recived "+typeof this.args[1]);e=a.getPassageMetadata(r),t=this.args[1],s=this.args[2]}else{if("string"!=typeof this.args[0]&&"number"!=typeof this.args[0])return this.error("Invalid type for second argument: expected string or number, but recived "+typeof this.args[0]);e=a.getPassageMetadata(),t=this.args[0],s=this.args[1]}e.setValue(t,s),a.storeState()}})};class PassageMetadataApp{constructor(a="PassageMetadata",e="byTag",t={filterTag:"passage_metadata"}){this.passageMetadataWidgetName=a,this._isPassageMetadataAppInitialized=!1,this._isPassageMetadataCollected=!1,this._isPassageStateLoaded=!1,this._isPassageMetadataWidgetsInitialized=!1,this.sugarcubeFacade=new SugarcubeFacade,this.passageMetadataCollector=new PassageMetadataCollector.A(this.sugarcubeFacade,this.passageMetadataWidgetName,e,t),this.passageMetadataStateManager=new PassageMetadataStateManager(this.sugarcubeFacade),this._realCurrentPassage=this.sugarcubeFacade.getCurrentPassage(),$(document).on(":passageinit",(a=>{this._realCurrentPassage="string"==typeof a.passage.name?a.passage.name:a.passage.title})),$(document).on(":passagestart",(()=>{!1===this._isPassageMetadataAppInitialized&&(this.collect(),this.initWidgets()),this.loadState()})),this.onBeforeAddMetadata=this.passageMetadataCollector.onBeforeAddMetadata,this.onAfterAddMetadata=this.passageMetadataCollector.onAfterAddMetadata,this.onBeforeStore=this.passageMetadataStateManager.onBeforeStore,this.onBeforeRestore=this.passageMetadataStateManager.onBeforeRestore}get isPassageMetadataAppInitialized(){return this._isPassageMetadataAppInitialized}get isPassageMetadataCollected(){return this._isPassageMetadataCollected}get isPassageStateLoaded(){return this._isPassageStateLoaded}get isPassageMetadataWidgetsInitialized(){return this._isPassageMetadataWidgetsInitialized}resetPassageStateLoaded(){this._isPassageStateLoaded=!1}get realCurrentPassage(){return this._realCurrentPassage}collect(a=!1){if(!0===a||!0!==this._isPassageMetadataCollected){this._isPassageMetadataCollected=!0;try{this.passageMetadataCollection=this.passageMetadataCollector.collect()}catch(a){throw a instanceof PassageMetadataError.A&&(a.message+=" ("+Object.keys(a.scope).map((e=>`${e}: ${a.scope[e]}`)).join(", ")),a}}}loadState(a=!1){if(!0===a||!0!==this._isPassageStateLoaded){this._isPassageStateLoaded=!0;try{this.passageMetadataStateManager.restore(this.passageMetadataCollection)}catch(a){throw a instanceof PassageMetadataError.A&&(a.message+=" ("+Object.keys(a.scope).map((e=>`${e}: ${a.scope[e]}`)).join(", ")),a}}}initWidgets(){!0!==this._isPassageMetadataWidgetsInitialized&&(this._isPassageMetadataWidgetsInitialized=!0,this.sugarcubeFacade.addMacros(this.passageMetadataWidgetName,{handler:function(){return this.error("Passage metadata was not processed, please check passage tags")}}),macros(this,this.sugarcubeFacade))}storeState(){this.passageMetadataStateManager.store(this.passageMetadataCollection)}isHasPassageMetadata(a=null){if(!1===this.isPassageMetadataCollected)throw new Error("Passage matadata was not collected");return null===a&&(a=this._realCurrentPassage),this.passageMetadataCollection.has(a)}getPassageMetadata(a=null){if(!1===this.isPassageMetadataCollected)throw new Error("Passage matadata was not collected");return null===a&&(a=this._realCurrentPassage),this.passageMetadataCollection.find(a)}getPassageMetadataValue(a,e=null){var t;if(!1===this.isPassageMetadataCollected)throw new Error("Passage matadata was not collected");let s=this._realCurrentPassage,r=null;if(null===e)r=a;else{if("string"!=typeof a)throw new TypeError(`${this.constructor.name}.getPassageMetadataValue: Invalid type for argument 'passageNameOrKey'. Expected string, got ${typeof a}.`);s=a,r=e}return null===(t=this.passageMetadataCollection.find(s))||void 0===t?void 0:t.data[r]}}PassageMetadataAppExport=__webpack_exports__})();